# TIL ( Today I Learned )

# **2022.11.08 😁** 

- ## AWS 인프라 구축 공부 
    - 서비스 운영이 쉬워지는 AWS 인프라 구축 가이드 책 살펴보며 정리 및 실습 진행 

<1장>
- 운영 서버 소개

<1-1>
- 운영 서버 관리의 세 단계
    - 운영 서버 관리는 크게 '환경 구성', '코드 배포', '모니터링' 이라는 세 단계로 나뉜다.
    - 환경 구성
        - 서비스할 코드를 구동시킬 수 있는 서버 인프라를 구축하는 것이다.
    - 코드 배포
        - 구성된 환경에서 최신 버전의 코드를 빠르고 안전하게 배포하는 것이다.
    - 모니터링
        - 안정적인 서비스 운영을 위해 서버와 코드에 어떤 이상이 없는지 바로 파악하고 대응할 수 있게 도와주는 것이다.

***

<2장>
- 운영 서버 환경의 구성 
    - 2장 에서는 운영 서버 관리 세 단계중 하나인 환경 구성에 대해 정리 


<2-1>
- 운영 서버 아키텍처의 이해
    - 단일 서버 
        - 가장 기본적인 구성
        - 요청 보내는 클라이언트와 요청을 처리하는 서버 한대 
            - 여기서 클라이언트는 휴대폰 앱이나 크롬과 같은 웹브라우저 의미 
        - 서버 내에는 애플리케이션 코드와 데이터베이스가 실행됨
        - 매우 단순한 구성이고 테스트 서버나 간단한 애플리케이션 서비스할 때 많이 사용 
        
        - 단점
            - 1. 전체 서비스에 장애가 생길 확률이 높다.
                 애플리케이션과 데이터베이스가 같은 자원을 공유하기 때문에 둘 중 하나라도 자원을 모두 사용해버리거나
                 서버 하드웨어에 장애가 발생시 전체 서비스가 완전히 죽어버린다.
            
            - 2. 서버 자원을 효율적으로 사용하기 어렵다.
                 애플리케이션과 데이터베이스는 각 속성에 따라 더 중요한 자원의 종류(CPU,메모리,디스크)나 
                 최적화를 위해 필요한 OS설정(I/O 컨트롤러, 디스크 설정)이 다를수 있다. 
                 둘 다 만족시키기 위해 필요 이상의 고사양 서버를 사용해야 할 수 있음.
            
            - 3. 보안성이 떨어진다.
                 데이터베이스는 보안상 포트나 IP 등 접속 지점을 최소한으로 하는 것이 좋다.
                 하지만 웹 애플리케이션 특성상 다양한 IP 주소와 포트 번호에 대해 요청을 받을 수 있어야 하고
                 서버 내 여러 파일들도 업로드 될 수 있으므로 데이터베이스가 공격당할 가능성이 높아진다.
            
            - 4. 스케일 아웃이 힘들다.
                 서버 자원의 확장을 위해 서버를 여러대로 늘려야 하는 경우 클라이언트에서는 추가된 서버들의 주소를 
                 새로 알아야 하며 데이터도 똑같은 복제본이 여러 개 생기므로 관리하기가 매우 힘들어진다.

    - 애플리케이션/데이터베이스 서버 분리 
        - 단일 서버 구성에서 데이터베이스를 별도로 분리한 구성이다.
        - 애플리케이션과 데이터베이스가 다른 자원을 사용하기 때문에 단일 서버에서 나온 전체 서비스 장애 확률,
          효율적인 자원 사용, 떨어지는 보안성과 같은 단점들이 해결된다.
        - 다만 두 대의 서버를 관리하기 때문에 구성이 조금 더 복잡해 지고 서버 사이의 지연 시간과 네트워크 보안을 고려하기 시작해야 한다.
        - 클라이언트에서는 여전히 하나의 서버를 바라보고 있기 때문에 스케일 아웃은 힘들다 

    - 서버 단위의 로드 밸런서 
        - 클라이언트가 애플리케이션을 실행하는 서버와 직접 통신하는 대신 로드 밸런서라는 서버와 통신하고 그 뒤에 여러 대의 애플리케이션 서버를 두는 방식
        - 클라이언트는 로드 밸런서하고만 통신하고 로드 밸런서가 클라이언트에게서 받은 요청을 뒤에 있는 서버들에 나눠준다
          뒤에 있는 서버들이 요청을 처리하면 응답은 로드 밸런서를 통해 클라이언트에 전달된다.
        - 이 구성의 가장 큰 장점은 '스케일 아웃'이 가능해 진다는 것이고 애플리케이션 서버 중 일부 서버에 장애가 발생해도 
          로드 밸런서에서 정상 서버에만 요청을 주면 되기 때문에 서비스 장애를 최소화 할 수 있다. 
        - 다만, 모든 요청이 로드 밸런서를 통해 지나가기 때문에 로드 밸런서에 장애가 생기면 나머지 서버들이 정상이어도 전체 서비스 장애로 이어지기 때문에 주의 필요
        - 또한, 구성이 매우 복잡해 진다는 단점도 있다
        - 흔히 OSI 7 계층의 L4 스위치라고 얘기하는 것이 이 로드 밸런서의 역할을 하는 장비 이다.

    - 서버 내 앱 단위의 로드 밸런서 
        - 여러 서버에게 요청을 분산하는 서버 단위 로드 밸런서 외에도 여러 애플리케이션 프로세스들에 요청을 분산시키는 앱 단위 로드 밸런서
        - 애플리케이션 서버 안에서 똑같은 애플리케이션을 여러 프로세스로 만들어 실행해 놓고 외부에서 들어온 요청을 프로세스 중 하나로 보내주는 역할
        - 이처럼 구성하면 하나의 서버에 여러 개의 프로세스를 실행해 하나의 서버에서 여러 개의 요청을 동시에 처리할 수 있으며 
          서버 자원을 최대한으로 사용할 수 있는 만큼의 프로세스를 실행해 서버 자원도 더욱 효율적으로 사용할 수 있다. 

<2-2>
- AWS EC2를 이용한 서버 인스턴스 생성과 관리 
    - EC2 생성하려면 꼭 알아야 하는 개념만 정리 (알고있는 거니 간단히 정리만)
        - EC2를 생성하기 위해 가장 먼저 알야할 개념 세 가지
            - 1. AMI
                 - EC2에 우리가 원하는 운영체제, 그리고 원하는 환경이 구성된 서버를 설치할 수 있다.
            - 2. 보안그룹
                 - 보안을 위해 IP와 포트 번호를 이용해 정의해두는 서버 접속 규칙 
                 - 특정 IP와 포트에 대해서만 서버에 접속을 허용
            - 3. 키페어 
                 - 서버에 접속하기 위한 열쇠 
                 - 공개 키 암호화 기법으로 서버에는 공개키 (public key)를 두고 사용자는 개인키 (private key)를 들고 접속하게 된다.
                 - 개인키는 유출될 경우 허가 받지 않은 사람도 서버에 접속 할 수 있으니 안전하게 보관 필수 
            
    - 샘플 프로젝트를 실행하기 위한 서버 환경 구성 
        - 실습 책 p24 참고 
            

<2-3>
- 소스코드 배포 
    - Git을 이용한 소스코드 배포 
        - 코드를 실행할 수 있는 서버와 환경이 준비됐으니 그다음으로 할 작업은 실행할 코드를 서버에 배포하는 것
        - 코드를 배포하는 방법으로 여러가지가 있지만 이번에는 가장 간단한 방법인 Git 을 이용한 배포 진행 
        - 서버에 접속한 뒤 Git 저장소에 있는 소스코드를 그대로 EC2 인스턴스로 내려 받고 코드 실행에 필요한 의존성 패키지 설치 
    
    - 실습 책 p25~26 참고
    

<2-4>
- 웹 서버와 웹 애플리케이션 서버 
    - 서버 인스턴스에는 클라이언트의 요청을 받아 적절한 정적 파일을 응답하거나 애플리케이션 코드로 그 요청을 처리 할 수 있게 도와주는 
      서버 소프트웨어가 필요하다. 서버 소프트웨어는 크게 웹 서버와 웹 애플리케이션 서버로 구분된다.

    - 1. 웹 서버 
        - 웹 서버는 클라이언트에서 HTTP 프로토콜로 요청을 받고 정적인 파일들을 응답으로 전달
        - 회사 소개 페이지와 같이 단순하고 정적인 웹 사이트는 웹 서버로 실행할수 있다
        - 로그인, 데이터베이스 접속 등 서버에서 코드를 실행할 필요가 있는 애플리케이션은 웹 서버만으로는 실행할 수 없다. 
        - 대표적인 웹 서버 제품으로 nginx(엔진엑스), Apache, IIS 등이 있다. 

    
    - 2. 웹 애플리케이션 서버 
        - Web Application Server 줄요서 WAS 라고 많이 얘기한다. 
        - 웹 서버와 다르게 클라이언트의 요청에 대해서 코드 실행을 통해 '동적인 응답'을 만들어주는 역할을 한다. 
        - 배포한 코드를 프로세스로 실행시키고, 해당 프로세스에 클라이언트의 요청을 넘겨주는 역할을 하기도 한다. 
        - 소스코드를 실행하고 관리하는 소프트웨어다 보니 제품마다 지원하는 언어가 다르다
        - 따라서 애플리케이션의 언어에 맞는 웹 애플리케이션 서버를 선택해야 한다. 
        - 대표적인 웹 애플리케이션 서버로는 phusion passenger, Apache Tomcat, JBoss 등이 있다.

    - 3. 웹 서버와 웹 애플리케이션 서버의 사용 
        - 웹 서버와 웹 애플리케이션 서버는 보통 함께 사용 된다.
        - 한 서버에서 여러 종류의 애플리케이션을 서비스 하는 경우 웹 서버가 정적 파일을 처리하는 역할이나 여러 웹 애플리케이션 서버로 
          라우팅하는 역할을 할 수 있다. 
            - 예를 들어 한 서버 내에서 a-site.com 사이트와 b-site.com 사이트를 모두 서비스 하고 있다면 웹 서버에서는 클라이언트에서 요청한
              도메인 주소를 분석해서 적절한 애플리케이션 서버로 전달해줄 수  있다. 또한 이미지나 CSS 같은 정적인 데이터는 굳이 애플리케이션을 실행해서
              로드할 필요 없이 웹 서버에서 바로 응답으로 주면 된다. 


    - 4. 클라이언트의 요청 이동 경로 
        - 1. 클라이언트에서는 네트워크와 ISP(인터넷 서비스 프로바이더) 등을 거쳐 서버 인스턴스로 네트워크 패킷을 보낸다.
        - 2. 하드웨어인 서버 인스턴스에서는 해당 패킷을 읽어와 인스턴스에 설치된 서버 OS 에 패킷을 넘긴다.
        - 3. 서버 OS는 해당 패킷을 읽고 패킷에 적힌 포트를 리스닝하고 있는 웹 서버 프로세스에 요청 내용을 전달한다. 
        - 4. 웹 서버에서는 해당 HTTP 요청을 분석해서 적절한 웹 애플리케이션 서버에 전달 한다. 
        - 5. 웹 애플리케이션 서버에서는 애플리케이션 코드를 실행하고 있는 애플리케이션 포르세스에 HTTP 요청의 내용을 파라미터를 전달해서 실행한 뒤 
             그 코드의 결과값을 다시 웹 서버에 전달한다. 
        - 6. 그 뒤로는 앞서 진행했던 단계의 반대 방향으로 클라이언트에게 응답이 전달 된다.

    
    - 5. nginx(엔진엑스), Phusion Passenger 
        - nginx는 전 세계에서 약 38%의 점유율을 차지하고 있는 대표적인 웹 서버 제품중 하나이다.
        - nginx는 꼭 필요한 웹 서버의 기능들을 모두 제공 한다. 

        - 웹 애플리케이션인 Phusion Passenger는 여러 언어로 된 (Node.js, Python, Ruby, Meteor) 애플리케이션들을 지원하고 
          문서화가 굉장히 잘 돼있다는 장점이 있다.

        - Phusion Passenger는 별도의 웹 서버 없이 단독으로 동작하는 독립형 모드, 아파체 웹 서버와 연동되어 실행 되는 아파치 통합모드, 
          nginx 웹 서버와 연동되어 실행되는 nginx 통합 모드를 지원한다.

    - 6. nginx, Phusion Passenger 실습 
        - p30 ~ p42 참고 
