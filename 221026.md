# TIL ( Today I Learned )

# **2022.10.26 ğŸ˜** 

- ## ì¿ ë²„ë„¤í‹°ìŠ¤ ê³µë¶€ 

<2-1>
- ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì¹˜í•˜ê¸° 
    - ì„¤ì¹˜ ì—†ì´ ì¿ ë²„ë„¤í‹°ìŠ¤ ì‚¬ìš©í•˜ê¸° 
        - ì¹´íƒ€ì½”ë‹¤ ì¿ ë²„ë„¤í‹°ìŠ¤ í”Œë ˆì´ ê·¸ë¼ìš´ë“œ 
            - Master, node1ì´ êµ¬ì„±ë˜ì–´ ìˆì–´ ë°”ë¡œ ì‚¬ìš©ê°€ëŠ¥ (1ì‹œê°„ë§Œ)
        - Play with Kubernetes
            - Docker ì—ì„œ ì œê³µ. Docker hub ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ 
            - 4ì‹œê°„ ì‚¬ìš© ê°€ëŠ¥. Master, worker nodeë¥¼ ì§ì ‘ êµ¬ì„±í•œ í›„ ì‚¬ìš© ê°€ëŠ¥ 
    
    - í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì—ì„œ ì œê³µí•˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ ë„êµ¬ 
        - êµ¬ê¸€ ì¿ ë²„ë„¤í‹°ìŠ¤ ì—”ì§„ (GKE)
        - ì•„ë§ˆì¡´ ì¿ ë²„ë„¤í‹°ìŠ¤ ì¼ë˜ìŠ¤í‹± ì»¨í…Œì´ë„ˆ ì„œë¹„ìŠ¤ (EKS)
        - ì• ì € ì¿ ë²„ë„¤í‹°ìŠ¤ ì„œë¹„ìŠ¤ (AKS)


***

<2-2>
- ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì¹˜í•˜ê¸°
    - ì§ì ‘ ì„¤ì¹˜í•˜ê¸° 
        - kubeadm (íë¸Œì–´ë“œë¯¼)
            - ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ê³µì‹ ì œê³µí•˜ëŠ” í´ëŸ¬ìŠ¤í„° ìƒì„±/ê´€ë¦¬ ë„êµ¬ 
        - kubespray (íë¸ŒìŠ¤í”„ë ˆì´)
            - ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ë¥¼ ë°°í¬í•˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ 
            - ë‹¤ì–‘í•œ í˜•ì‹ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° êµ¬ì„±ê°€ëŠ¥
            - ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œ ìƒìš© ì„œë¹„ìŠ¤ í´ëŸ¬ìŠ¤í„° ìš´ì˜ì‹œ ìœ ìš©
            - ë‹¤ì–‘í•œ CNI ì œê³µ 
                - CNI (Container Network Interface)
                    - Containerê°„ í†µì‹ ì„ ì§€ì›í•˜ëŠ” VxLAN, Pod Network ë¼ê³ ë„ ë¶€ë¦„ 
                    - ë‹¤ì–‘í•œ ì¢…ë¥˜ì˜ í”ŒëŸ¬ê·¸ ì¸ì´ ì¡´ì¬ 
                    - ì»¨í…Œì´ë„ˆì™€ ì»¨í…Œì´ë„ˆê°€ í†µì‹ í•˜ë ¤ê³  í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤
                    - ì¿ ë²„ë„¤í‹°ìŠ¤ ì‚¬ìš©í•˜ë ¤ë©´ ë°˜ë“œì‹œ CNI êµ¬ì„± í•´ì•¼í•¨ 
                    - í”Œë¼ë„¬(flannel), ì¹¼ë¦¬ì½”(calico), ìœ„ë¸Œë„·(weavnet) ì¤‘ í•˜ë‚˜ëŠ” ë°˜ë“œì‹œ ì„¤ì¹˜ í•´ì•¼ ì»¨í…Œì´ë„ˆì™€ ì»¨í…Œì´ë„ˆê°„ í†µì‹  í•  ìˆ˜ ìˆë‹¤. 
    
        - ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° êµ¬ì„± 
            - control plane (master node)
                - ì›Œì»¤ ë…¸ë“œë“¤ì˜ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê³  ì œì–´ 
                - single master
                - multi master (3, 5ê°œì˜ master nodes)
            - worker node
                - ë„ì»¤ í”Œë«í¼ì„ í†µí•´ ì»¨í…Œì´ë„ˆë¥¼ ë™ì‘í•˜ë©° ì‹¤ì œ ì„œë¹„ìŠ¤ ì œê³µ 
            
        - VMWAREì— ubuntuë¡œ  master, node1, node2 ìƒì„± 
            - Xshell ì—ì„œ ì—°ê²° í•´ì„œ ì‚¬ìš© 
                - Xshell ì—ì„œ master, node1, node2 ì—°ê²° ë°©ë²• 
                    - ì¼ë‹¨ ê° ì„œë²„ ssh ê°€ ì„¤ì¹˜ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ í•´ì•¼í•¨ (ì„¤ì¹˜ í•„ìˆ˜)
                        - sudo dpkg -l | grep ssh 
                        - sudo netstat -lntp (ssh ë¦¬ìŠ¤ë„ˆê°€ ë–  ìˆëŠ”ì§€ í™•ì¸) 
                            - netstat ëª…ë ¹ì–´ ì•ˆë¨¹ìœ¼ë©´ net-tools ì„¤ì¹˜í•´ì•¼í•¨ 
                                - sudo apt install net-tools 
        
                        - sudo apt-get install ssh  
                            - ssh ì„¤ì¹˜ ì™„ë£Œ ì‹œ Xshell ì—ì„œ ì—°ê²° ê°€ëŠ¥ 

        - kubeadm ì„ ì´ìš©í•œ ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì¹˜ - ì˜¨í”„ë ˆë¯¸ìŠ¤ 
             1. Docker Install (master, node1, node2) - docs.docker.com
                - ìœ„ ì‚¬ì´íŠ¸ ì ‘ì†í•´ì„œ "Download and install" í´ë¦­
                - Docker Desktop for Linux í´ë¦­
                - ì™¼ìª½ì— Installation per Linux distro í´ë¦­
                - Install on Ubuntu í´ë¦­
                    - ì €ì¥ì†Œ ì„¤ì •, ë„ì»¤ ì—”ì§„ ì„¤ì¹˜ ëª…ë ¹ì–´ ë³µì‚¬í•˜ì—¬ ì‹¤í–‰ (install ì˜†ì— -y í•œì¹¸ ë„ìš°ê³  ë¶™ì—¬ì£¼ê¸° install -y )
                    - ì‚¬ì „ ì ìš© ëª…ë ¹ì–´ 
                        sudo apt-get update
                        sudo apt-get install -y \
                        ca-certificates \
                        curl \
                        gnupg \
                        lsb-release


                        sudo mkdir -p /etc/apt/keyrings
                        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

                        echo \
                        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
                        $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

                        sudo apt-get update
                        sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

                    - ì„¤ì¹˜ í™•ì¸ ëª…ë ¹ì–´ 
                        sudo systemctl enable docker 
                        sudo systemctl start docker 
                        sudo docker version

            2. Kubernetes Install
                - ì„¤ì¹˜ ì „ í™˜ê²½ì„¤ì • 
                - kubeadm, kubectl, kubelet ì„¤ì¹˜ 
                - control-plane êµ¬ì„±
                - worker node êµ¬ì„±
                - ì„¤ì¹˜ í™•ì¸ 

                - ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì¹˜
                    - kubernetes.io ì ‘ì† 
                    - Documentation í´ë¦­
                    - Set up a cluster ì—ì„œ install the kubeadm setup tool í´ë¦­ 

                    - ì„¤ì¹˜ ì „ í™˜ê²½ ì„¤ì • (root ë¡œê·¸ì¸ í›„ ëª…ë ¹ì–´ ì…ë ¥, ê·¸ë˜ì„œ ëª…ë ¹ì–´ì— sudo ë‹¤ ë¹ ì ¸ìˆëŠ” ê²ƒ  )
                        - master, node1, node2 ì— swap disabled í•„ìˆ˜ë¡œ ì‚¬ì „ ì ìš© í•´ì•¼í•¨ 
                        - swap disabled (Swap disabled. You MUST disable swap in order for the kubelet to work properly. )
                            swapoff -a && sed -i '/swap/s/^/#/' /etc/fstab
                        - Disable firewall
                            - systemctl stop firewalld
                              systemctl disable firewalld
                        - IPv4 ì „ë‹¬ ë° iptables ê°€ ë¸Œë¦¬ì§€ëœ íŠ¸ë˜í”½ì„ ë³¼ ìˆ˜ ìˆë„ë¡ í—ˆìš© 
                            - cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
                              overlay
                              br_netfilter
                              EOF

                              modprobe overlay
                              modprobe br_netfilter

                              cat <<EOF | tee /etc/sysctl.d/k8s.conf
                              net.bridge.bridge-nf-call-iptables  = 1
                              net.bridge.bridge-nf-call-ip6tables = 1
                              net.ipv4.ip_forward                 = 1
                              EOF

                              sysctl --system

                    
                    - kubeadm, kubectl, kubelet ì„¤ì¹˜ 
                        - apt-get update
                          apt-get install -y apt-transport-https ca-certificates curl
                          curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
                          echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
                          apt-get update
                          apt-get install -y kubelet kubeadm kubectl
                          apt-mark hold kubelet kubeadm kubectl
                          
                          systemctl start kubelet
                          systemctl enable kubelet


                    - control-plane êµ¬ì„± 
                        - master ì—ì„œ ë§Œ!!! ëª…ë ¹ì–´ ì ìš© (ì ˆëŒ€ ë…¸ë“œì—ì„œ ì ìš© í•˜ì§€ ë§ ê²ƒ)
                            - kubeadm init 
                            - ì˜¤ë¥˜ ë‚˜ë©´ êµ¬ê¸€ ì°¾ì•„ë´ë¼..
                            - ì™„ë£Œ ë˜ë©´ kubeadm join 192.~ -- token  ì´ë ‡ê²Œ ë‚˜ì˜¨ë‹¤ 
                                - í† í°ì€ ì €ì¥ í•´ ë‘¬ì•¼í•¨
                                - ì €ì¥ ë°©ë²• 
                                    - cat > token.txt ë¶™ì—¬ë„£ê¸° (ì»¨íŠ¸ë¡¤ + d)
                                    - cat token.txt ë¡œ ì €ì¥ëœ ê²ƒ í™•ì¸ 
                                ... control-plane êµ¬ì„± ì—ì„œ ë§‰í˜... ìš°ë¶„íˆ¬ ë²„ì „ ë¬¸ì œ .. 22.04 ì—ì„œ ë¬¸ì œ ë°œìƒ.. 18.04 ë¡œ ì¬ì„¤ì¹˜ í›„ ì²˜ìŒë¶€í„° ì§„í–‰..
                            
                            - kubectl get nodes ëª…ë ¹ì–´ ì‹¤í–‰ 
                                - ì•ˆë¨
                                - kubectl ëª…ë ¹ ì‹¤í–‰ì‹œ ì•„ë˜ ëª…ë ¹ì–´ ì„  ì…ë ¥í›„ kubectl ëª…ë ¹ì–´ ì‹¤í–‰í•˜ë©´ ëœë‹¤.
                                    -   mkdir -p $HOME/.kube
                                        sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
                                        sudo chown $(id -u): $(id -g) $HOME/.kube/config
                                    - ìœ„ ëª…ë ¹ì–´ ì‹¤í–‰ í›„ kubectl get nodes ëª…ë ¹ì–´ ì‹¤í–‰ ì‹œ ì •ìƒ ë™ì‘ 
                                    - root ê³„ì •ì—ì„œ exit í›„ ì¼ë°˜ ì‚¬ìš©ìì—ê²Œë„ ìœ„ ëª…ë ¹ì–´ ì…ë ¥í•´ì„œ kubectl ëª…ë ¹ ì‹¤í–‰ í•  ìˆ˜ ìˆê²Œ í•´ì¤Œ
                                    - kubectl get nodes ëª…ë ¹ì–´ ì‹¤í–‰ì‹œ STATUS ëŠ” ì—¬ì „íˆ NotReady ë¡œ ë‚˜ì˜´ (CNI ì„¤ì¹˜ ì•ˆí–ˆê¸° ë•Œë¬¸)
                            
                            - CNI ì„¤ì¹˜ (Pod Network add-on)
                                - Weave Networks ì„¤ì¹˜ 
                                    - kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')"
                                    - ìœ„ ëª…ë ¹ì–´ ì…ë ¥ì‹œ ì˜¤ë¥˜ 
                                        - kubectl apply -f https://github.com/weaveworks/weave/releases/download/v2.8.1/weave-daemonset-k8s.yaml
                                        - ìœ„ ëª…ë ¹ì–´ ì…ë ¥ì‹œ ì •ìƒ ë™ì‘ 


                    - Worker node êµ¬ì„± 
                        - ë§ˆìŠ¤í„° ì™€ ì¡°ì¸ ì‹œì¼œì¤˜ì•¼í•¨ 
                        - master ì—ì„œ cat token.txt ë¡œ ì €ì¥í•œ í† í°ì„ ë³µì‚¬ í•´ì„œ node1, node2 ì— ë¶™ì—¬ë„£ê¸° 
                        - ë¶™ì—¬ ë„£ëŠ” ì™€ì¤‘ì— container runtime is not running: output : ~~~ ì˜¤ë¥˜ ë°œìƒ 
                            - í•´ê²° ë°©ë²• 
                                - sudo rm /etc/containerd/config.toml
                                - sudo systemctl restart containerd 
                                - ìœ„ ëª…ë ¹ì–´ í•´ì£¼ê³  ë‹¤ì‹œ í† í° ë¶™ì—¬ë„£ê¸° 
                    
                        - ì¿ ë²„ë„¤í‹°ìŠ¤ ì‚¬ì´íŠ¸ì—ì„œ kubectl cheat sheet ê²€ìƒ‰ í›„ 
                            - source <(kubectl completion bash)
                              echo "source <(kubectl completion bash)" >> ~/.bashrc 
                            - ìœ„ ëª…ë ¹ì–´ ì…ë ¥ì‹œ íƒ­í‚¤ ëˆ„ë¥´ë©´ ìë™ì™„ì„± ê¸°ëŠ¥ ìƒê¸´ë‹¤. 
                            - kubeadm ëª…ë ¹ì–´ë„ ìë™ì™„ì„± ê¸°ëŠ¥ í•˜ê³  ì‹¶ìœ¼ë©´ ìœ„ ëª…ë ¹ì–´ ì—ì„œ kubectl ì„ kubeadm ìœ¼ë¡œ ë°”ê¾¼í›„ ì ìš© ì‹œí‚¤ë©´ ëœë‹¤.
                    


                    - ì„¤ì¹˜ í™•ì¸ 
                        - kubectl get nodes -o wide ëª…ë ¹ì–´ë¡œ í™•ì¸ 